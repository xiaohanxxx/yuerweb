<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="è‚²å„¿ç½‘ï¼Œè¯•ç®¡å©´å„¿ï¼Œè¯•ç®¡å©´å„¿å’¨è®¯å¹³å°">
    <meta name="description" content="å­•å„¿ç½‘å…¨çƒè¯•ç®¡å©´å„¿äº¤æµå¹³å°ã€‚ä¸“æ³¨äºä¸å­•ä¸è‚²ï¼Œè¯•ç®¡å©´å„¿ï¼Œå¤‡å­•è‚²å„¿äº¤æµï¼Œæä¾›å…¨çƒè¯•ç®¡å©´å„¿åŒ»é™¢èµ„è®¯ï¼ŒåŒ»ç”Ÿé¢„çº¦ï¼Œäº†è§£è¯•ç®¡å©´å„¿è´¹ç”¨ï¼Œè¯•ç®¡å©´å„¿æˆåŠŸç‡ï¼Œä»¥åŠè¯•ç®¡å©´å„¿ç–‘éš¾é—®é¢˜è§£å†³æœåŠ¡ç­‰ï¼Œä¸ºæ‚¨çš„å®‰å…¨å­•è‚²ä¿é©¾æŠ¤èˆªï¼">
    <link rel="stylesheet" href="{% static 'css/coment.css' %}">
    <link rel="stylesheet" href="{% static 'css/yuerlt.css' %}">
    <link rel="stylesheet" href="{% static 'css/iconfont.css' %}">
    <script src="{% static 'js/uitls/jquery.min.js' %}"></script>
    <script src="{% static 'js/uitls/avalon.js' %}"></script>
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/uitls/tool.js' %}"></script>
    <script src="{% static 'js/uitls/jquery.emoji.js' %}"></script>
    <script src="{% static 'layui/layui.all.js' %}"></script>
    <title>{{ data.title }}-è¯•ç®¡å©´å„¿_è‚²å„¿ç½‘</title>
</head>
<body>
{% include 'header.html' %}
<!-- è¯é¢˜å¤´éƒ¨ -->
<section class="topicHead wid" style='margin-top:30px;' ms-controller="topicArc">
    <div class="currdis clearfix">
        <div class="dqwz">å½“å‰ä½ç½®ï¼š</div>
        <div class="lmmbx">
            <a href="/luntan">è‚²å„¿è®ºå›</a>
            <span>></span>
            <a href="javascript:;">{{ data.title }}</a>
        </div>
    </div>
    <div class="imgbox">
        <img src="{% static 'images/yuerlt/topic_bg.png' %}" alt="">
    </div>
</section>
<!-- è¯é¢˜ä¸»ä½“éƒ¨åˆ† -->
<section class="topicMain wid clearfix" ms-controller="topicArc">
    <div class="topic_l fl">
        <div class='clearfix'>
            <div class="userInfo">
                <div class="Mtx">
                    {% if request.user.is_active %}
                        <a href="/users/centerhim/{{ data.user.id }}">
                            <img src="/media/{{ data.user.head }}" alt="">
                        </a>
                    {% else %}
                        <a href="/login">
                            <img src="/media/{{ data.user.head }}" alt="">
                        </a>
                    {% endif %}


                </div>
                <div class="txInfo">
                    <span>{{ data.user.username }}</span>
                    <span>{{ data.publish_date.date }}</span>
                </div>
                {% if request.user.is_active %}
                    <div class="isFollow" userid="{{ data.user.id }}" data-isFollow='flase' ms-click="posgz(this)">
                        å…³æ³¨ä½œè€…
                    </div>
                {% else %}
                    <div class="isFollow" data-isFollow='flase'>
                        <a href="/login">å…³æ³¨ä½œè€…</a>
                    </div>
                {% endif %}
            </div>

            <p class='title'>{{ data.title }}</p>
            <div class="allInfo">
                <p commid="{{ data.id }}">
                    {{ data.content |safe }}
                </p>
            </div>
            <div class="plbox fr">
                <div><span>è¯„è®º</span><i>|</i><span>{{ data.commentnum }}</span></div>
                {% if request.user.is_active %}
                    <div><span>ç‚¹èµ</span><i>|</i><span>{{ data.thumbup }}</span></div>
                {% else %}
                    <div><a href="/login"><span>ç‚¹èµ</span><i>|</i><span>{{ data.thumbup }}</span></a></div>
                {% endif %}
            </div>
        </div>
        <div class="plInpbox clearfix">
            <span>è¯„è®º</span>
            <div class="pl_head">
                <div class="bqBtn" style="position:relative;">
                    <div id="emoji">ğŸ˜„</div>
                </div>
                <textarea name="khlypl" id="khlypl" placeholder="è¿™é‡Œè¾“å…¥å†…å®¹"></textarea>
                <div name="result" contenteditable="true" style='display:none;'></div>
            </div>
            <div id="NopostBtn" class='fl'>å–æ¶ˆè¯„è®º</div>
            {% if request.user.is_active %}
                <span id="plintBtn" class="fr" onclick="goPostcomm(this)"><a href="javascript:;">å‘å¸ƒ</a></span>
            {% else %}
                <span id="plintBtn" style="margin-top:10px;" class="fr"><a href="/login">å‘å¸ƒ</a></span>
            {% endif %}
        </div>
        <div class="pl_lis">
            <div class="pl_lis_h clearfix">
                <span class='fl'><em>{ plallnum }</em>è¯„è®º</span>
            </div>
            <div class="pl_info" infobox="box">
                {#  è¿™æ˜¯é€’å½’å¼€å§‹#}

                {# è¿™æ˜¯é€’å½’ç»“æŸ #}
            </div>
        </div>

    </div>
    <div class="topic_r fl">
        <style>
            .tjjlbox {
                padding-right: 12px;
            }

            .tjjlbox img {
                float: left;
            }

            .tjjlbox li {
                height: 40px;
                line-height: 40px;
                margin: 20px 0;
                font-size: 14px;
            }

            .tjjl-h {
                border-bottom: 1px solid #eee;
                padding-right: 15px;
            }

            .tjjl-h h3 {
                height: 40px;
                line-height: 40px;
                border-bottom: 1px solid #FF44AD;
                width: 100px;
                text-align: center;
                font-size: 18px;
            }
        </style>
        {% include 'mod_tjjl.html' %}
        {# çƒ­é—¨è¯é¢˜è°ƒç”¨ #}
        {% include 'mod_yuerlthot.html' %}
    </div>
</section>
{% include 'footer.html' %}

<script>
    var vm_topicArc = avalon.define({
        $id: 'topicArc',
        comment: [],
        articles_id: 0,//å¸–å­id
        parent_id: 0,//å›å¸–å¯¹åº”çš„çˆ¶id
        plallnum: '',
        posgz: function (ev) {
            var _this = ev;
            $.ajax({
                url: '/users/followapi',
                type: 'post',
                data: {
                    'type': 0,
                    'Quser_id': $(_this).attr('userid'),
                    'csrfmiddlewaretoken': glob_csrftoken
                },
                success: function (ajax) {
                    $('.userInfo .isFollow').html('å·²å…³æ³¨')
                    layer.msg(ajax.msg);
                }, error: function (error) {
                }
            })
        },
        guzhuinit: function () {
            var userid = $('.isFollow').attr('userid');
            $.ajax({
                url: '/users/followapi',
                type: 'post',
                data: {
                    'type': 2,
                    'Quser_id': userid,
                    'csrfmiddlewaretoken': glob_csrftoken
                },
                success: function (ajax) {
                    if (ajax.data_list) {
                        for (var i = 0; i < ajax.data_list.length; i++) {
                            if (ajax.data_list[i].userid == userid) {
                                $('.userInfo .isFollow').html('å·²å…³æ³¨');
                            }
                        }
                    }
                }, error: function (error) {
                    console.log(error);
                }
            })
        }
    });
    vm_topicArc.guzhuinit();
    vm_topicArc.articles_id = window.location.href.replace(/.*aid=/, '');
    var infoBox = $('div[infobox="box"].pl_info');//è¯„è®ºçˆ¶çº§ç›’å­

    initdataHtml();//åˆå§‹åŒ–è¯„è®ºæ•°æ®
    {#è¯„è®ºåˆ·æ–°#}

    function initdataHtml() {//è¯„è®ºæ•°æ®å±€éƒ¨æ¸²æŸ“
        $.ajax({
            url: '/luntan/comment/?articles_id=' + vm_topicArc.articles_id,
            type: 'get',
            dataType: 'json',
            success: function (ajax) {
                var datalis = ajax.data;
                vm_topicArc.plallnum = ajax.data.length | 0;
                var comment = [];
                for (var i = 0; i < datalis.length; i++) {
                    if (datalis[i].parent == null) {
                        comment.push(datalis[i]);
                    } else {
                        Toolfun.diguiClass(datalis, comment);
                    }
                }
                infoBox.html(html(comment.reverse()));
                readyClick();

            }, error: function (error) {
                console.log(error);
            }
        })
    }

    {#è¯„è®ºé€’å½’ä¸€å±‚#}

    function html(comment) {//ç¬¬ä¸€ä¸ªä¸ºæ•°æ®ï¼Œç¬¬äºŒä¸ªä¸ºé€’å½’ä½“
        var htmldata = '';
        for (var a in comment) {
            var newstr = diguipilun(comment[a].child, comment[a], a);
            htmldata += '<div class="pl clearfix" ><div class="tx">{% if request.user.is_active %}<a href="/users/centerhim/'+comment[a].user.id+'"><img src="/media/'+ comment[a].user.head+ '" alt=""></a>{% else %}<a href="/login">';htmldata += '<img src="/media/'+ comment[a].user.head +'" alt=""></a>{% endif %}</div><p class="plbg">' + comment[a].user.username + '</p>';
            htmldata += '<ul class="plul"><p commid=' + comment[a].id + '>ã€€ã€€' + comment[a].comment + '</p><div class="date clearfix">';
            htmldata += '<span>' + comment[a].publish_date.replace(/\d+:.*/, '') + '</span><span btn="reply" dataInp="' + a + '" onclick="sonIfshow(this)">å›å¤</span></div>';
            htmldata += newstr;
            htmldata += '<div class="pl_inpbox" dataInp="' + a + '"><div class="plinput"><div class="plinput-h" style="position:relative;"><div bq_btn="emoji">ğŸ˜„</div>';
            htmldata += '</div><textarea name="pl_Input"></textarea><div name="result" contenteditable="true" style="display:none;"></div>';
            htmldata += '</div><span name="qxplBtn" onclick="sonQxcomm(this)" class="fl">å–æ¶ˆè¯„è®º</span>';
            htmldata += '{% if request.user.is_active %}<span name = "plintBtn" class= "fr" onclick = "sonPostcomm(this)"> <a href = "javascript:;"> å‘å¸ƒ </a></span> {% else %}<span name = "plintBtn" class= "fr" onclick = ""> <a href = "/login"> å‘å¸ƒ </a></span>{% endif %}';
            htmldata += '</div></ul></div>';
        }
        return htmldata;
    }

    {#è¯„è®ºé€’å½’å‡½æ•°#}

    function diguipilun(comment, Mcomment, Mid) {//commentï¼šå­çº§æ‰€æœ‰æ•°æ®ï¼ŒMcommentå•ä¸ªçˆ¶çº§æ•°æ®ï¼ŒMidçˆ¶çº§å…ƒç´ çš„ç´¢å¼•
        var diguistr = '';
        if (!comment) {
            return 'ã€€';
        }
        for (var a in comment) {
            diguistr += '<ul class="hfplbox"><div class="pl clearfix"><p class="plbg plbg2"><span class="afuser">' + comment[a].user.username + '</span>';
            diguistr += '<span>å›å¤äº†</span><span class="befuser">' + Mcomment.user.username + '</span></p><ul class="plul">';
            diguistr += '<p commid="' + comment[a].id + '">ã€€ã€€' + comment[a].comment + '</p><div class="date"><span>' + comment[a].publish_date.replace(/\d+:.*/, '') + '</span>';
            diguistr += '<span btn="reply" dataInp="' + Mid + '" onclick="sonIfshow(this)">å›å¤</span></div></ul></div>';
            if (comment[a].child) {
                for (var b in comment[a].child) {
                    diguistr += '<ul class="hfplbox"><div class="pl clearfix"><p class="plbg plbg2"><span class="afuser">' + comment[a].child[b].user.username + '</span>';
                    diguistr += '<span>å›å¤äº†</span><span class="befuser">' + comment[a].user.username + '</span></p><ul class="plul">';
                    diguistr += '<p commid="' + comment[a].child[b].id + '">ã€€ã€€' + comment[a].child[b].comment + '</p><div class="date"><span>' + comment[a].child[b].publish_date.replace(/\d+:.*/, '') + '</span>';
                    diguistr += '<span btn="reply" dataInp="' + Mid + '" onclick="sonIfshow(this)">å›å¤</span></div></ul></div>';
                    diguistr += diguipilun(comment[a].child[b].child, comment[a].child[b], Mid);
                    diguistr += '</ul>';
                }
            }
            diguistr += '</ul>';
        }
        return diguistr;
    }

    {#    æ–‡æœ¬è¾“å…¥æ¡†#}
    /*è¡¨æƒ…åˆå§‹åŒ–
       content_el: è¾“å…¥æ¡†çš„ä½ç½®
             list: ä¸‹çš„å±æ€§è¯¦è§£
                 name		-- åˆ†ç±»åç§°
                 code 		-- åˆ†ç±»çš„è¡¨æƒ…ç¼–ç ï¼Œä¸å…¶ä»–åˆ†ç±»ä¸å¯é‡å¤
                 path 		-- å›¾ç‰‡è·¯å¾„
                 suffix		-- å›¾ç‰‡çš„åç¼€
                 max_number	-- å›¾ç‰‡çš„æœ€å¤§ä¸ªæ•°
 */
    //è¡¨æƒ…åŒ…å‡½æ•°,ç»‘å®šæŒ‚è½½
    function bqbaofunc(bqbtn, textbox) {//bqbtn ä¸ºè¡¨æƒ…æ˜¾ç¤ºæŒ‰é’®ï¼Œtextboxä¸ºæ–‡æœ¬å­˜å‚¨ç›’å­
        bqbtn.emoji({
            content_el: textbox,
            list: [{
                name: "QQè¡¨æƒ…",
                code: "qq_",
                path: "{% static "/face/emoji1/" %}",
                suffix: ".gif",
                max_number: 25
            }, {
                name: "emoji",
                code: "em_",
                path: "{% static "/face/emoji2/" %}",
                suffix: ".png",
                max_number: 22
            }, {
                name: "å…¶ä»–",
                code: "other_",
                path: "{% static "/face/emoji3/" %}",
                suffix: ".png",
                max_number: 1
            }]
        });
    }

    //è¡¨æƒ…æ ¼å¼æ›¿æ¢
    function replace_em(str) {
        str = str.replace(/\</g, '&lt;');
        str = str.replace(/\>/g, '&gt;');
        str = str.replace(/\n/g, '<br/>');
        str = str.replace(/\[qq_([0-9]*)\]/g, "<img src='/static/face/emoji1/$1.gif' />");
        str = str.replace(/\[em_([0-9]*)\]/g, "<img src='/static/face/emoji2/$1.png'/>");
        str = str.replace(/\[other_([0-9]*)\]/g, "<img src='/static/face/emoji3/$1.png'/>");
        return str;
    }

    {#å¸–å­å†…å®¹åˆ¤æ–­#}

    function commIfpost(topicid, commid, comment, dom) {
        var truedata = {};
        if (commid != "") {
            truedata = {
                "articles_id": topicid,
                "parent_id": commid,
                "comment": comment,
                'csrfmiddlewaretoken': glob_csrftoken
            }
        } else {
            truedata = {
                "articles_id": topicid,
                "comment": comment,
                'csrfmiddlewaretoken': glob_csrftoken
            }
        }
        if (topicid && comment.length < 600 && comment != "") {
            $.ajax({
                url: '/luntan/comment/',
                type: 'post',
                data: truedata,
                success: function (ajax) {
                    initdataHtml();
                    layer.msg("è¯„è®ºæˆåŠŸ");
                },error:function(error){
                    layer.msg('æäº¤ä¸æˆåŠŸï¼Œè¯·ä»æ–°æäº¤ï¼');
                    setTimeout(function(){
                        location.reload();
                    },2000)
                }
            })
        } else if (comment == "") {
            layer.msg("è¯·è¾“å…¥")
        } else {
            layer.msg('åªèƒ½è¾“å…¥600ä¸ªå­—ç¬¦,');
        }
    }

    {#ç‚¹èµä¸è¯„è®º#}
    $('.plbox>div').eq(1).click(function () {//ç‚¹èµ
        if (this.onSelect) {
            return false;
        } else {
            this.onSelect = true;
            $.ajax({
                url: '/luntan/thumbup/?aid=' + vm_topicArc.articles_id,
                type: 'get',
                dataType: 'text',
                success: function (ajax) {
                    layer.msg(ajax, {'time': 1000});
                    if (ajax.length > 5) {
                        return false;
                    }
                    location.reload();
                }
            })
        }
    })
    $('#NopostBtn').click(function () {
        $('#khlypl').val('');
    })
    //è¯„è®ºäº‹ä»¶å¤„ç†
    var Mpostbox = $('#khlypl');
    var emoji = $('#emoji');
    bqbaofunc(emoji, Mpostbox);//ä¸»è¯„è®º
    $("#plintBtn").click(function () {
        var content = $("#khlypl").val();
        content = replace_em(content);//è§£æè¡¨æƒ…
        $("div[name='result']").eq(0).html(content);
        $("#khlypl").val('');
    });

    {# çˆ¶çº§ä¸€å±‚å›å¤#}

    function goPostcomm(ev) {
        $(document).ready(function () {
            var _this = ev;
            var topicid = $(_this).parent().prev().find("div.allInfo p").attr("commid"),
                commid = '',
                comment = $(_this).prev().prev().find("div[name='result']").html().replace(/\'/, "").trim();
            commIfpost(topicid, commid, comment, $(_this).parent());
        })
    }

    {#å­çº§ç»‘å®šçš„å›å¤äº‹ä»¶#}

    function sonIfshow(ev) {//ç‚¹å‡»å›å¤äº‹ä»¶
        $(document).ready(function () {
            var that = ev;
            var index = $(that).attr("datainp");
            vm_topicArc.parent_id = $(that).parent().prev().attr("commid");
            $('.pl_info>div.pl').eq(index).find(".pl_inpbox").show();
        })
    }

    {# ç»™è¯„è®ºåˆ—è¡¨æ·»åŠ å‘å¸ƒäº‹ä»¶ #}

    function sonPostcomm(ev) {
        $(document).ready(function () {
            var _this = ev;
            var textBox = $(_this).prev().prev().children("textarea");
            var plbox = $(_this).parent();
            var qxpl = $(_this).prev();
            var result = $(_this).prev().prev().children('div[name="result"]');
            var topicid = vm_topicArc.articles_id,
                commid = vm_topicArc.parent_id,
                comment = "";
            var content = textBox.val();
            content = replace_em(content);
            result.html(content);
            comment = result.html().replace(/\'/, "").trim();
            commIfpost(topicid, commid, comment, plbox);
            textBox.val("");
        })
    }

    {#å–æ¶ˆè¯„è®ºäº‹ä»¶#}

    function sonQxcomm(ev) {
        $(document).ready(function () {
            var that = ev;
            $(that).prev().find("textarea").val('');
            $(that).prev().find("div[name='result']").html("");
            $(that).parent().hide();
        })
    }

    function readyClick() {//å¯¹æ¸²æŸ“åçš„è¡¨æƒ…ç»‘å®šäº‹ä»¶
        $(document).ready(function () {
            var pls = $('.pl_info>div.pl');
            for (var i = 0; i < pls.length; i++) {
                var emibtn = pls.eq(i).find('div[bq_btn="emoji"]');
                var textBox = pls.eq(i).find('textarea[name="pl_Input"]');
                var result = pls.eq(i).find('div[name="result"]');
                bqbaofunc(emibtn, textBox);//è¡¨æƒ…äº‹ä»¶æŒ‚è½½
            }
        })
    }
</script>
</body>

</html>